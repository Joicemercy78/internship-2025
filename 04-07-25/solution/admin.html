<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
</head>
<body class="bg-light">
<div class="container py-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h5 class="mb-0 text-muted">Total Users</h5>
      <h4 class="fw-bold text-primary" id="totalUsers">0</h4>
    </div>
    <div>
      <span class="text-muted">Welcome, <strong id="adminName"></strong></span>
      <button onclick="logout()" class="btn btn-danger btn-sm ms-3">
        <i class="bi bi-box-arrow-right me-1"></i>Logout
      </button>
    </div>
  </div>

  <div class="text-center mb-4">
    <div class="card border-0 shadow-sm d-inline-block px-4 py-3">
      <h5 class="fw-bold text-primary mb-2">Admin Profile</h5>
      <div><strong>Name:</strong> <span id="adminNameDisplay"></span></div>
      <div><strong>Email:</strong> <span id="adminEmailDisplay"></span></div>
      <div><strong>Admin ID:</strong> <span id="adminIdDisplay"></span></div>
    </div>
  </div>

  <div class="card shadow border-0 p-4">
    <h5 class="fw-semibold mb-3"><i class="bi bi-people me-2"></i>User Management</h5>
    <input type="text" class="form-control mb-3" id="searchInput" placeholder="Search users...">

    <div class="table-responsive">
      <table class="table table-bordered align-middle">
        <thead class="table-primary">
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>User ID</th>
            <th>Admin ID</th>
            <th>Role</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody id="userList"></tbody>
      </table>
    </div>

    <nav class="mt-3">
      <ul class="pagination justify-content-center" id="pagination"></ul>
    </nav>
  </div>
</div>

<script>
  
  const currentUser = JSON.parse(localStorage.getItem("currentUser")); // currentuser key stores username mail and imp role
  let allUsers = JSON.parse(localStorage.getItem("users")) || [];

  // Check current user role is admin if not redirect login page
  if (!currentUser || currentUser.role !== "admin") {
    window.location.href = "login.html";
  }

  // --- Display Admin Profile Details ---
  document.getElementById("adminName").textContent = currentUser.username;
  document.getElementById("adminNameDisplay").textContent = currentUser.username;
  document.getElementById("adminEmailDisplay").textContent = currentUser.email;
  document.getElementById("adminIdDisplay").textContent = currentUser.adminId || "JOY123";

  const userListBody = document.getElementById("userList");                 // <tbody> 
  const searchInput = document.getElementById("searchInput");               // search bar
  const totalUsersDisplay = document.getElementById("totalUsers");          // total user count
  const paginationContainer = document.getElementById("pagination");        // pagination links

  // --- Pagination Variables ---
  const rowsPerPage = 5;
  let currentPage = 1;

  // to search using filter function returns a new array which match the search input
  function filterUsers() {
    const searchKeyword = searchInput.value.toLowerCase();
    return allUsers.filter(user => 
      user.email !== currentUser.email &&                     // Don't show the currently logged-in admin 
      (user.username.toLowerCase().includes(searchKeyword) || // Check if username contains search keyword
       user.email.toLowerCase().includes(searchKeyword) ||    // Check if email contains search keyword
       user.userId.toLowerCase().includes(searchKeyword))     // Check if user ID contains search keyword
    );
  } 
 
  function renderUsers(page = 1) {                  // which page of users to show.
    const filteredUsers = filterUsers();            
    const startIndex = (page - 1) * rowsPerPage;
    const usersOnCurrentPage = filteredUsers.slice(startIndex, startIndex + rowsPerPage);  //return a copy of a array in a new array

    totalUsersDisplay.textContent = allUsers.length;  // Update the total user count

    // Clear the existing user rows in the table
    userListBody.innerHTML = "";

    usersOnCurrentPage.forEach(user => {
      const tableRow = document.createElement("tr");         // Create a new table row element
      const isUserAdmin = user.role === "admin";             // Check if the current user in the loop is an admin

      tableRow.innerHTML = `          
        <td>${user.username}</td>
        <td>${user.email}</td>
        <td>${user.userId}</td>
        <td>${user.adminId || "-"}</td> 
        <td>
          <span class="badge ${isUserAdmin ? 'bg-primary' : 'bg-secondary'} text-uppercase">
            ${user.role} </span>
        </td>
        <td class="text-center">
          ${!isUserAdmin ? `<button class="btn btn-success btn-sm me-2" onclick='promoteUser("${user.email}")'><i class="bi bi-person-check"></i> Promote</button>` : ""}
          <button class="btn btn-danger btn-sm" onclick='confirmRemove("${user.email}")'><i class="bi bi-trash"></i> Remove</button>
        </td>
      `;
      userListBody.appendChild(tableRow); // add the new row to the table body
    });

    // After rendering users, also update the pagination links
    renderPagination(filteredUsers.length);
  }

  //  creates and updates pagination
  function renderPagination(totalFilteredItems) {
    const totalPages = Math.ceil(totalFilteredItems / rowsPerPage); // Calculate total pages needed
    paginationContainer.innerHTML = "";          // Clear existing pagination links

    // Loop to create a link for each page
    for (let i = 1; i <= totalPages; i++) {
      const listItem = document.createElement("li"); // Create a new list item for the page link
      listItem.className = `page-item ${i === currentPage ? "active" : ""}`;
      listItem.innerHTML = `<a class="page-link" href="#">${i}</a>`; 

      // Add a click event listener to each page link
      listItem.addEventListener("click", (event) => {
        event.preventDefault();                            // Prevent from reloading 
        currentPage = i;                                 
        renderUsers(currentPage);                         // Re-render the users for the new page
      });
      paginationContainer.appendChild(listItem); 
    }
  }

  //  promote user to admin 

  function promoteUser(userEmailToPromote) {
    // Find the index of the user
    const userIndex = allUsers.findIndex(user => user.email === userEmailToPromote);

    if (userIndex !== -1) {
      const existingAdminsWithIds = allUsers.filter(user => user.role === "admin" && user.adminId);
      let lastAdminIdNumber = 0;
      if (existingAdminsWithIds.length > 0) {
        // Get the largest number from existing Admin IDs 
        lastAdminIdNumber = Math.max(...existingAdminsWithIds.map(admin => parseInt(admin.adminId.replace("ADM", "") || 0)));
      }
      // Create a new admin id
      const newAdminId = "ADM" + String(lastAdminIdNumber + 1).padStart(3, "0");

      allUsers[userIndex].role = "admin";                           // update user role 
      allUsers[userIndex].adminId = newAdminId;                     // update admin id
      localStorage.setItem("users", JSON.stringify(allUsers));      // save to local storage

      renderUsers(currentPage); 
    }
  }

  // remove User 
  function confirmRemove(userEmailToRemove) {
    const wantsToRemove = confirm("Are you sure you want to remove this user?");

    if (wantsToRemove) {
      allUsers = allUsers.filter(user => user.email !== userEmailToRemove);
      localStorage.setItem("users", JSON.stringify(allUsers));
      renderUsers(currentPage);
    }
  }

  function logout() {
    localStorage.removeItem("currentUser"); 
    window.location.href = "login.html"; 
  }


  // when search, reset to the first page and re-render users.
  searchInput.addEventListener("input", () => { 
    currentPage = 1;                                    
    renderUsers(currentPage);                           
  });

  renderUsers(currentPage);
</script>
</body>
</html>